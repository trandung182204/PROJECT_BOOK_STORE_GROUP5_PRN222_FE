<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Books Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background: #f8f9fa; }
    .koparion-header {
      background: #fff;
      padding: 15px 20px;
      border-bottom: 2px solid #f28d00;
    }
    .koparion-logo { color:#f28d00;font-size:26px;font-weight:bold; }
    .btn-kop { background:#f28d00;color:#fff; }
    .btn-kop:hover { background:#d67b00;color:#fff; }
    img.thumb { width:55px;height:70px;object-fit:cover;border-radius:5px; }
    .table th { background:#f28d00;color:white; }
  </style>
</head>
<body>

  <header class="koparion-header d-flex justify-content-between align-items-center">
    <div class="koparion-logo">Koparion</div>
    <h4 class="m-0">ðŸ“š Book Management</h4>
    <button class="btn btn-kop" data-bs-toggle="modal" data-bs-target="#bookModal">
      <i class="bi bi-plus-circle me-1"></i> Add Book
    </button>
  </header>

  <div class="container mt-4">
    <table class="table table-bordered align-middle text-center">
      <thead>
        <tr>
          <th>#</th>
          <th>Code</th>
          <th>Title</th>
          <th>Author</th>
          <th>Publisher</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Status</th>
          <th>Thumbnail</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="bookTable"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="bookForm">
          <div class="modal-header">
            <h5 class="modal-title">Add / Edit Book</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body row g-3">
            <input type="hidden" id="bookId">
            <div class="col-md-6">
              <label class="form-label">Code</label>
              <input type="text" id="code" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Title</label>
              <input type="text" id="title" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Author</label>
              <input type="text" id="author" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Publisher</label>
              <input type="text" id="publisher" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Price</label>
              <input type="number" step="0.01" id="price" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Discount Price</label>
              <input type="number" step="0.01" id="discountPrice" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Stock Quantity</label>
              <input type="number" id="stockQuantity" class="form-control">
            </div>
            <div class="col-md-8">
              <label class="form-label">Thumbnail URL</label>
              <input type="url" id="thumbnailUrl" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Status</label>
              <select id="status" class="form-select">
                <option value="Available">Available</option>
                <option value="Out of stock">Out of stock</option>
                <option value="Hidden">Hidden</option>
              </select>
            </div>
            <div class="col-md-12">
              <label class="form-label">Description</label>
              <textarea id="description" class="form-control" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-kop">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://localhost:7108/api/Book";
    let JWT_TOKEN = ""; // náº¿u backend cÃ³ [Authorize], gÃ¡n token á»Ÿ Ä‘Ã¢y
    const tableBody = document.getElementById('bookTable');
    const form = document.getElementById('bookForm');
    const modal = new bootstrap.Modal(document.getElementById('bookModal'));

    function err(e){
      console.error(e);
      Swal.fire({ icon:'error', title:'Error', text: e.message || 'Request failed' });
    }
    function money(n){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n||0); }
    async function fetchJSON(url, options = {}){
      const headers = options.headers || {};
      headers['Content-Type'] = 'application/json';
      if(JWT_TOKEN) headers['Authorization'] = 'Bearer ' + JWT_TOKEN;
      const res = await fetch(url, {...options, headers});
      if(!res.ok) throw new Error(await res.text() || res.statusText);
      return res.status === 204 ? null : res.json();
    }

    /* ------- Load Books ------- */
    async function loadBooks(){
      try{
        const data = await fetchJSON(API_BASE);
        tableBody.innerHTML = data.map((b,i)=>`
          <tr>
            <td>${i+1}</td>
            <td>${b.code}</td>
            <td>${b.title}</td>
            <td>${b.author ?? '-'}</td>
            <td>${b.publisher ?? '-'}</td>
            <td>${money(b.price)}</td>
            <td>${b.stockQuantity ?? 0}</td>
            <td><span class="badge ${b.status==='Available'?'bg-success':b.status==='Out of stock'?'bg-danger':'bg-secondary'}">${b.status}</span></td>
            <td>${b.thumbnailUrl?`<img src="${b.thumbnailUrl}" class="thumb">`:'-'}</td>
            <td>
              <button class="btn btn-sm btn-warning me-1" onclick="editBook(${b.id})"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger" onclick="deleteBook(${b.id})"><i class="bi bi-trash"></i></button>
            </td>
          </tr>
        `).join('');
      }catch(e){ err(e); }
    }

    /* ------- Add or Update ------- */
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      try{
        const id = document.getElementById('bookId').value;
        const book = {
          code: code.value,
          title: title.value,
          author: author.value,
          publisher: publisher.value,
          price: parseFloat(price.value||0),
          discountPrice: parseFloat(discountPrice.value||0),
          stockQuantity: parseInt(stockQuantity.value||0),
          thumbnailUrl: thumbnailUrl.value,
          status: status.value,
          description: description.value
        };
        if(id){
          await fetchJSON(`${API_BASE}/${id}`, {method:'PUT', body:JSON.stringify(book)});
          Swal.fire({icon:'success',title:'Updated successfully'});
        }else{
          await fetchJSON(API_BASE, {method:'POST', body:JSON.stringify(book)});
          Swal.fire({icon:'success',title:'Added successfully'});
        }
        modal.hide();
        form.reset();
        loadBooks();
      }catch(e){ err(e); }
    });

    /* ------- Edit ------- */
    async function editBook(id){
      try{
        const b = await fetchJSON(`${API_BASE}/${id}`);
        document.getElementById('bookId').value = b.id;
        for(const key in b){ if(document.getElementById(key)) document.getElementById(key).value = b[key] ?? ''; }
        modal.show();
      }catch(e){ err(e); }
    }

    /* ------- Delete ------- */
    async function deleteBook(id){
      if(!confirm('Delete this book?')) return;
      try{
        await fetchJSON(`${API_BASE}/${id}`, {method:'DELETE'});
        Swal.fire({icon:'success',title:'Deleted successfully'});
        loadBooks();
      }catch(e){ err(e); }
    }

    loadBooks();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
